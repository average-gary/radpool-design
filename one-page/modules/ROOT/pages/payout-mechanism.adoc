= Payout Mechanism
:stem: latexmath

As described earlier, a syndicate of MSPs can:

. Generate a syndicate public key using a distributed key generation protocol.
. Generate a threshold signature for the syndicate.
. Relicate block templates and miner shares with verifiable ownership with consistency guarantees.

With the above facilities Radpool provides a DLC based payout
mechanism, where the MSP pays the miner for producing a certain hash
rate. The Radpool syndicate acts as the DLC oracle for each miner's
hashrate. We now describe the payment mechanism in detail. The later
sections show the various bitcoin transactions. First we describe the
requirements for the payout mechanism and then describe the protocols
that fulfill the requirements.

== Requirements

The Radpool payout mechanism has to meet a few requirements. We list
these first and once we have described the mechanism, show how it
meets these requirements.

Scalabale use of Block Space:: The payout mechanism should scale to
tens of thousands of miners.
Unilateral Exit:: The miner doesn't need permission from the syndicate to spend their reward.
No Centralised Coordinator:: The payout mechanism must not depend on a
central entity to co-ordinate payouts to miners.
Futures Contract:: The Miner and the MSP enter into a futures contract
exchanging hashrate for BTC. The contract is settled by Radpool's
syndicate acting as an oracle, without knowing the details of the
contract.

=== Scalabale Use of Block Space

This is an important requirement and is motivated by the scaling
issues faced by P2Pool
(https://bitcointalk.org/index.php?topic=18313.msg13057899#msg13057899[1],
https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2017-August/014893.html[2])
where the miner payouts competed with other transactions for block
space.

Chris Belcher
https://bitcointalk.org/index.php?topic=2135429.0[proposed a solution]
that required hubs to co-ordinate the payouts. We extended this idea
as an
https://github.com/pool2win/blog-and-docs/blob/main/proposal/proposal.pdf[alternative
proposal for Braidpool]. The proposal uses unidirectional payment
channels and removes the dependency on predicting miner payouts by
using a p2p DAG of shares. In Radpool, we propose replacing the hubs
with a syndicate whose members act as Mining Service Providers. These
MSPs provide liquidity, manage payouts as we explain later and
maintain a consistent replicated set of shares received from all
miners.

=== Unilateral Exit

A miner should be able to leave the mining pool with all the reward
that they have earned, without requiring permission from any syndicate
member. There are solutions, for example
https://gist.github.com/pool2win/77bb9b98f9f3b8c0f90963343c3c840f[Braidpool's
UHPO model] where miners need to send a request to the pool to obtain
their payout. With unilateral exits, a miner can leave any time and if
the syndicate becomes unreachable, the miner's payout is firmly within
their control.

=== No Centralised Coordinator

A centralised co-ordinator that makes payouts is an antithesis to a
decentralised mining pool. Often there are arguments that a mining
pool can make payouts over lightning network, however, all the designs
in operation today require a centralised lightning node operator to
make the payouts. Which means, that if the lightning node misbehaves
for any reason, the miners are directly impacted. In Radpool,
we make payouts in a way that does not depend on a single entity. As
long as a threshold of parties are behaving correctly, miner payouts
are updated and the miner can later unilaterally exit at any time.

=== Futures Contract

With increasing adoption of PPS instead of PPLNS, Radpool should
support an equivalent reward payout scheme where a miner and a capital
provider can agree on the exchange rate and expiry. Once the contract
is agreed upon, Radpool's syndicate should act as an oracle to settle
the contract and neither the miner nor the MSP should be able to block
the contract execution.

== Radpool Payout Mechanism

The Radpool payout mechanism uses DLCs for enabling a PPS like payout
mechanism. Miners enter into a contract with MSPs with agreed upon
exchange rate and an expiry, with Radpool acting as the oracle for the
payout contracts. We describe the contract transactions that make up
the Radpool payout mechanism and describe the interactive protocol
used by the Radpool MSPs and miners.

=== Miner Registration

When a miner joins the pool, the request is sent to an MSP the miner
is connected to. The MSP then triggers a miner registration protocol,
for the Syndicate to act as an Oracle for payout contracts between the
miner and the Syndicate. As part of the registration process, the
miner submits a public key stem:[m_pk] to the MSP. This key is used to
generate the DLC payout contracts between the MSP and the miner. The
miner also creates a username and password for authenticating future
stratum messages. As we'll see later, this username is also used
enable verifiable ownership of shares.

=== Radpool as the Oracle

In response to request from miner stem:[m] to join the pool, the
Radpool Syndicate runs a single instance of DKG to generate the public
key to be used to sign contract exection transactions. See
https://github.com/discreetlogcontracts/dlcspecs:[DLC specs] for
details on thes transaction. This DKG instance generates the
stem:[Y_m] value. The public nonce for the miner, stem:[R_m], is
generated by the MSP and broadcast to the syndicate. To prevent a DDoS
attack where an MSP repeatedly runs DKG instances, the MSP maintains a
queue of miner join requests, and runs a limited number of DKGs every
hour. The list of membership is replicated consistently by using the
BFT reliable broadcast and miner join requests are handled by running
a round robin request selection over MSPs. We avoid the requirement of
a totally ordered broadcast which will add to communication complexity.

Note that the same public key stem:[Y_m] is used for all future DLC
settlements for miner stem:[m]. This is mentioned in the DLC paper
as a safe thing to do. The paper also specifies that the nonce
stem:[R_m] should not be re-used and can be generated by a single
party. We therefore remove the requirement to run DKG to generate the
nonce and instead the MSPs generate the nonce for their miners for the
next settlement transaction and broadcasts it to the syndicate.

The two values stem:[Y_m] and stem:[R_m] are now available to all
MSPs. The miner is then sent these values by their MSP. The miner will
validate these received values by connecting to other syndicates and
confirming they have the same values. This is possible because all
MSPs allow connections and serve the public mining information.

With the public values now available, the syndicate can sign the
hashrate for a miner to settle that miner's DLC contract
payout. Before we describe how this works we desribe the terms of
contracts.

=== Contract Terms

Once the public values stem:[R_m] and stem:[Y_m] are published,
the miner and its MSP agree on the terms for the payout contract.

Expiry:: The block height at which the contract settles.
Hashrate:: The average hashrate that the miner will generate shares at
between now and the Expiry.
Amount:: The amount of bitcoin the MSP will pay the miner for the
Hashrate.

As required by DLC, the Expiry will be fixed, but there will be a
number of combinations of (Hashrate, Amount) that the MSP and the
miner will agree to. Here's an example list, showing a contract where
hashrate more than 1PH/s will pay the miner a million sats, and lower
than 0.8 PH/s will pay nothing, and the intermediate steps will pay
intermediate values. Note this list shows the contract terms at a high
level, Radpool will use the exponent/mantissa optimisation proposed in
the DLC paper to generate the full list of transactions necessary to
execute the contract terms.

[cols="1,1,1"]
|===
| Block height | Hashrate (PH/s) | Amount (sats)

| 900,000 | > 1 | 1,000,000

| 900,000 | 1 - 0.9 | 900,000

| 900,000 | 0.9 - 0.8 | 700,000

| 900,000 | < 0.8 | 0
|===

=== Funding and Refund Transactions

The funding transaction stem:[F_{{msp_i},{mj}}] between is funded
by the MSP and locks the output as a 2 of 2 multisig. MSP and the
miner thus agree on the txid and the output that will fund the payout
contract.

Before the MSP signs the funding transaction, the miner creates a
refund transaction that spends the funding transaction, returning the
entire amount to the MSP. The output of the refund transaction is
timelocked to extend beyond the contract expiry. The refund
transaction allows the MSP to claim back the funds in the case that
the miner leaves the pool before the contract expiry and doesn't claim
the contract payout.

=== Contract Execution Transactions

Contract execution transactions (CETs) spend funding transaction
outputs with the amount stem:[T] BTC. This amount is the amount
funding the contract and the maximum that the MSP can payout to the
miner. The amount needs to have a margin of safety and we discuss that
later in the <<Capital Requirements and Fees>> section.

The outputs of the CETs have two outputs, one for the miner
(labelled m) where the miner's public key is tweaked by stem:[s_iG =
R_m - h(i,R_m)Y_m]. The values stem:[R_m] and stem:[Y_m] were
published earlier by the syndicate as explained earlier in the section
<<Radpool as the Oracle>>.

Once a payout has to be made, the Syndicate calculates the
stem:[Balance] that has to be paid to the miner, and runs a TSS
instance to sign the message. The Syndicate has to be sure to use the
correct set of values when publishing the signature. The values
stem:[(R_m,Y_m, i)] have to be tracked for the current contract
being executed. The expiry and the miner public keys help track this
as the pool makes payouts.

.Contract Execution Transaction
image::payout-mechanism/cet.png[Contract Execution Transaction, 65%]

Once the syndicate has published a signature for a contract, the miner
can spend the output at any point in time. Note, unlike DLC contracts
described in the seminal paper the miner does not need to spend the
output within a time period as the MSP. It always has access to the
"change" from the contract.

.Roll-over Contract Transactions

The DLC contract mechanism described up to now requires two
transactions to make a single payout to a miner. One to create a
funding transaction and one to settle the DLC contract. However, the
DLC paper proposes a simple solution to the problem, which we adopt
here. Instead of settling the payout transaction on chain, the MSP and
the miner, roll over the payout into a new contract.

Payout roll-over is a two step protocol.

. A new refund transaction is created with the new balance paying the miner.
. The old CET is invalidated by the MSP handing over the revocation key for older CET's revocation transaction.

This scheme is
https://github.com/lightning/bolts/blob/master/03-transactions.md#commitment-transaction-outputs[same
as the one used in LN] to invalidate old commitment transactions -
i.e. by exchanging private keys for the old payout transaction.

.Payout Roll-over
image::payout-mechanism/payout-rollover.png[Funding and Refund Transactions, 65%]

== Meeting the Payout Requirements

Let's see how the above scheme meets the payout requirements we listed
at the outset.

Constant Block Space:: The coinbase of the block spends to a single
p2pkh - the syndicate public key generated using DKG.

Unilateral Exit:: The miner always has access to a UTXO that pays the
miner till the last contract expiry. It is up to the miner and the MSP
to agree on the expiry length. We expect MSPs to offer various expiry
and hashrate terms to meet their and miner risk preferences.

No Centralised Coordinator:: The Radpool syndicate acts as the oracle
to settle the miner payout contracts. The syndicate is run as a FROST
Federation and therefore eliminates dependency on any centralised
entity. As the pool grows and the number of MSPs grow, the size of the
federation increases.

Futures Contract:: The DLC based payout contract is a future contract
that delivers miners payouts dependent only on the hashrate they
generate.

=== Optimising Nonce Generation for Oracle Signatures

When contracts are due to expire the syndicate publishes a signature
to settle miner payouts. There's a couple of things that we highlight
here. First, given that the syndicate has to publish as many oracle
signatures as there are number of miners, we want to remove the need
to produce a nonce from the path when generating the
signatures. Instead, we use the approach that every time a miner payout
is rolled over or initially generated, the MSP broadcasts a nonce to
the syndicate.

.MSP publishes Nonce for miners
. MSP builds a message as `<MSP node id, miner username, Sequence number, R>`.
. MSP signs the message and broadcasts it to the syndicate.
. MSP sends the same signed message to the miner.
. Miner validates MSPs have received `R` via a reliable BFT broadcast.

Once the `R` value is published for each CET, the syndicate then
runs a TSS at contract expiry time. This make it possible to scale the
payout mechanism as we eliminate the time consuming nonce generation
phase and instead use the nonce supplied by the MSP.

=== Payout Interactive Protocol

Recall that payouts to MSPs are made once the pool finds a block,
while the payouts to miners are made by MSPs on contract expiry. We
now describe how the payouts to miners and MSPs are handled by an
interactive protocol such that neither MSPs nor miners can steal any
coins. The following protocol is executed as soon as the pool finds a
block and the coinbase becomes spendable after 100 blocks.

. When the pool finds a block the MSPs compute the fraction of the coinbase each of them are due by using the validated ownership of  `mining.submit` messages broadcast by each MSP.
. The above reward distribution algorithm uses the PPLNS approach to distribute rewards between MSPs.
. MSPs construct payout transactions paying out all MSPs and broadcast these to all MSPs.
. Once MSPs have validated everyone has broadcast and received their payout transaction, they start a TSS round to sign the coinbase transaction.
. The signed coinbase is retained by all MSPs and is broadcast once it has been confirmed up to 100 block depth.

The above protocol makes sure that all MSPs get their fare share of
payout. More importantly, by decoupling payouts to miners from payouts
to MSPs we make it clear that MSPs take on the risk of making PPS
payouts to miners.

=== Optimisations and Scalability

Transactions are broadcast at two different events.

Coinbase confirmed:: At this point we require stem:[|Syndicate| + 1]
number of transactions.
Miner collects payout:: When a miner collects their payout.

The payout mechanism allows for roll-over of both the transaction
types. As discussed earlier, miners can roll-over the their payouts to
reduce the on chain fees they need to pay. There is a possibility here
to move miner payout DLCs into LN contracts, but we leave that
optimisation out from this initial proposal.

In the same way as miners roll-over their payouts, the MSPs can also
signal to the syndicate to not sign their payouts until a minimum
balance is reached. This is a choice the MSP can make to lower on
chain transaction fees. Again, we leave such optimisations out of the
current proposal.

== Capital Requirements and Fees

All MSPs need to lock in capital to fund miner payouts. We propose
that each MSP keeps at least a 5x margin. Depending on how many miners
an MSP registers and the hashrate those miners have, the MSP will have
to lock in even more capital. We will provide MSPs with tools to
compute the safe amount of liquidity required based on the hashrate
their miners have.

The fee rates that the MSPs charge will be subject to open market
competition. Miners can look up various MSPs and decide on the MSP
based on the contract terms and the fees charged.


[TODO] Make sure we are covering the PPLNS computation. Normalisation
of shares. Computation from shares to hashrate in the DLC
contracts. Should the DLC contracts have hashrate or number of shares
as the contract trigger.
