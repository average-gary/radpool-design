== Federation Protocols

The federation and miners follow a number of separate protocols to
enable the system to work together.

=== Initial Setup

To start a new federation, any member announces their network
address. The threshold and federation size is set to one.

Miners that want to join the federation initiate their registration
with sole federation member and set their stratum end point to the
federation member.

.New federation with single member
[plantuml, target=intial-setup]
....
@startuml
Miner --> FederationMember: Register
FederationMember --> Miner: Auth token
Miner <--> FederationMember: Stratum auth, notify, submit
"Miner/Validtor" <-- FederationMember: Share broadcasts
@enduml
....

At this point, the sole federation member acts like a centralised pool
operator, with transparent share accounting.

=== New Federation Member

To join the federation, a new member has to lock in capital in to a
bitcoin transaction signed by the Federation using a Schnorr threshold
signautre. A successfully signed transaction signifes that a threshold
of the existing federation member agree to the new member joining.

The only criterion available for the existing federation members is the
amount of new capital the new member is bringing to the federation.

Each federation can decide the policies they want to adopt for
admitting new members by agreeing on the minimum and maximum bitcoin
that each member locks into the federation. This value is agreed out of
band and configured at federation start up time.

.New federation member
[plantuml, target=intial-setup]
....
@startuml
NewFederationMember --> ExistingMember: Join Request
ExistingMember <--> Federation: Reliable broadcast of Join Request
ExistingMember --> NewFederationMember: New funding tx (unsigned)
NewFederationMember --> ExistingMember: Partially signed funding tx
NewFederationMember <--> Federation: Run FROST to sign new tx
@enduml
....

=== Federation Member Exit

Similar to the protocol followed to add a new member to the federation,
the federation members create a new transaction with updated
balances. The member leaving the federation is part of the party that
runs the threshold signature instance to sign the input spending the
previous federation output.

=== Federation Member Failures

If a member fails (say is unresponsive), the federation continues to
operate as normal. If more than a threshold number of federation
members fail, the pool reaches end of life and all federation members
along with miners can claim their outputs after the timeout expiry.

See section on Bitcoin Contracts to see how the transactions are
structured.

=== New Miner Registration

A miner register with any of the federation members by following the
protocol to create a new authentication token. This can follow any of
the well known protocols like OAuth. The miner submits a public key to
which it should receive payouts.

A miner can obtain a similar authentication token from multiple
federation members. The miner should use the same public key to
register with multiple federation members.

Using this authentication token, the miner can open a communication
channel to send and receive stratum messages to the federation members.

At the end of the miner registration, the miner is in a position to
start sending shares to the federation.

.New Miner Registration
[plantuml, target=intial-setup]
....
@startuml

group Federation Member 1
NewMiner --> FederationMember_1: Register using HTTP API
NewMiner <-- FederationMember_1: Auth token 1
NewMiner --> FederationMember_1: Submit public key

NewMiner <--> FederationMember_1: Stratum communication
end

group Federation Member 2
NewMiner --> FederationMember_2: Register using HTTP API
NewMiner <-- FederationMember_2: Auth token 2
NewMiner --> FederationMember_2: Submit public key

NewMiner <--> FederationMember_2: Stratum communication
end
@enduml
....
